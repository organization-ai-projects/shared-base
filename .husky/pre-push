#!/bin/sh

# Stop script on error
set -e

# Check pnpm-lock.yaml
echo "ğŸ”’ Checking pnpm-lock.yaml..."
if ! pnpm install --frozen-lockfile --prefer-offline > /dev/null 2>&1; then
  echo "âŒ Lockfile check failed. Please ensure pnpm-lock.yaml is up to date."
  exit 1
fi

# Full linting
echo "ğŸ” Performing full linting..."
if ! pnpm lint; then
  echo "âŒ Linting failed. Please fix the issues before pushing."
  exit 1
fi

# Run tests with coverage
echo "ğŸ§ª Running tests with coverage..."
if ! pnpm test:coverage; then
  echo "âŒ Tests failed or coverage did not meet the required threshold."
  exit 1
fi

# Ensure no uncommitted changes
echo "ğŸ“‚ Checking for uncommitted changes..."
if ! git diff --exit-code > /dev/null 2>&1; then
  echo "âŒ Uncommitted changes detected. Please commit your changes before pushing."
  exit 1
fi

echo "âœ… All checks passed. Ready to push!"
